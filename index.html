<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rez√§pt</title>

    <meta property="og:title" content="Rez√§pt">
    <meta property="og:description" content="Feini Rez√§pt f√ºr jedi Gl√§geheit. Viu Spass bim Koche!">
    <meta property="og:image" content="https://ghi-fhi.github.io/recipe_webapp/favicon.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" type="image/png" href="favicon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f4f4f6;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-muted: #8e8e93;
            --accent: #ff9f0a;
            --radius: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            overscroll-behavior-y: none;
            font-weight: 700;
        }

        body.no-scroll { overflow: hidden; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin: 0;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            padding: 0.8rem 1.2rem;
            border: 1px solid #d1d1d6;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 700;
            background-color: var(--card-bg);
            transition: all 0.2s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(255, 159, 10, 0.15);
        }

        .btn-add {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(255, 159, 10, 0.4);
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            flex-shrink: 0;
        }

        .btn-add:hover { transform: scale(1.05); }

        #filterBar { margin-bottom: 2rem; padding-bottom: 0.5rem; }

        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }

        .tag-chip {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 999px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            line-height: 1;
            background-color: hsl(var(--hue), 80%, 45%);
            color: white;
        }

        .filter-chip {
            cursor: pointer;
            font-size: 0.85rem;
            padding: 8px 16px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-color: hsl(var(--hue), 60%, 90%);
            color: hsl(var(--hue), 80%, 25%);
        }

        .filter-chip:hover { transform: translateY(-2px); filter: brightness(0.95); }

        .filter-chip.active {
            background-color: hsl(var(--hue), 80%, 45%);
            color: white;
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 12px hsla(var(--hue), 80%, 45%, 0.3);
        }

        .filter-all { background-color: #e5e5ea !important; color: var(--text-main) !important; }
        .filter-all.active { background-color: var(--text-main) !important; color: white !important; box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important; }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid rgba(0, 0, 0, 0.08);
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.04);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 25px rgba(0,0,0,0.08); }
        .card-img { width: 100%; height: 200px; object-fit: cover; background-color: #e5e5ea; }
        .card-content { padding: 1.2rem; }
        .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.3rem; }

        ::view-transition-group(*) { animation-duration: 0.35s; }

        dialog {
            border: none;
            border-radius: var(--radius);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            padding: 0;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            margin: auto;
            background: var(--card-bg);
            color: var(--text-main);
            overflow-x: hidden;
            overflow-y: auto;
        }

        dialog[open] { animation: modalZoomIn 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        dialog[open]::backdrop { animation: backdropFadeIn 0.3s ease forwards; }

        @keyframes modalZoomIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes backdropFadeIn { from { opacity: 0; } to { opacity: 1; } }

        .btn-close {
            position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.85); backdrop-filter: blur(4px);
            border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.2rem; cursor: pointer;
            font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background 0.2s; z-index: 10;
        }
        .btn-close:hover { background: rgba(255,255,255,1); }

        .modal-desktop-split { display: flex; flex-direction: column; }
        .modal-image-col { width: 100%; }
        .modal-img { width: 100%; height: 250px; object-fit: cover; background-color: #e5e5ea; display: block; }
        .modal-info-col { padding: 1.5rem; }
        .modal-steps-col { padding: 0 1.5rem 1.5rem 1.5rem; }

        .modal-body { padding: 2rem; }
        .modal-title { font-size: 2rem; margin-bottom: 0.5rem; line-height: 1.2; font-weight: 700; }

        .ingredients-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-top: 1.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 10px;
        }

        .btn-share {
            background-color: var(--card-bg);
            color: var(--accent);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .btn-share:hover { background-color: var(--accent); color: white; }

        h3 { font-size: 1.2rem; color: var(--accent); margin: 0; font-weight: 700; }
        ul, ol { margin-left: 1.5rem; line-height: 1.6; }
        li { margin-bottom: 0.5rem; }

        .portions-control {
            display: inline-flex; align-items: center; background: #f4f4f6; border-radius: 20px; padding: 4px 6px;
        }
        .portions-control button {
            background: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 1.2rem;
            color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s; font-weight: 700;
        }
        .portions-control button:active { transform: scale(0.9); }
        .portions-control span { font-weight: 700; font-size: 0.9rem; min-width: 80px; text-align: center; }

        form { display: flex; flex-direction: column; gap: 1rem; }
        .form-row { display: flex; gap: 1rem; }
        .form-col-main { flex: 1; }
        .form-col-side { width: 90px; }
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin-top: -0.5rem; }

        label { font-weight: 700; font-size: 0.9rem; }
        input, textarea { width: 100%; padding: 0.8rem; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 1rem; font-family: inherit; font-weight: 700; }
        input[type="checkbox"] { width: auto; transform: scale(1.2); cursor: pointer; }
        input[type="file"] { padding: 0.5rem; background: #f4f4f6; border: 1px dashed #d1d1d6; cursor: pointer; font-weight: 700; }
        input:disabled { background-color: #e5e5ea; color: #8e8e93; cursor: not-allowed; }
        input:focus, textarea:focus { outline: none; border-color: var(--accent); }
        textarea { resize: vertical; min-height: 100px; }

        .btn-submit {
            background-color: var(--accent); color: white; border: none; border-radius: 10px;
            padding: 1rem; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 1rem; transition: background-color 0.2s;
        }
        .btn-submit:disabled { background-color: #d1d1d6; cursor: not-allowed; }
        .help-text { font-size: 0.8rem; color: var(--text-muted); margin-top: -0.5rem; font-weight: 400; }

        /* --- PINTEREST-STYLE CONTEXT MENU --- */
        #contextMenu {
            visibility: hidden;
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
            z-index: 100;
            display: flex;
            flex-direction: row;
            padding: 8px;
            gap: 6px;

            transform: scale(0.4) translateY(20px);
            opacity: 0;
            transform-origin: bottom center;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease;
        }

        #contextMenu.show {
            visibility: visible;
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .context-btn {
            background: transparent;
            border: none;
            border-radius: 20px;
            padding: 14px 20px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            color: var(--text-main);
            transition: all 0.2s ease;
            min-width: 85px;
        }

        .context-btn:hover { background: rgba(0,0,0,0.05); transform: translateY(-2px); }
        .context-btn:active { transform: scale(0.95); }
        .context-icon { font-size: 1.6rem; line-height: 1; }
        .context-label { font-size: 0.75rem; }
        .context-btn.delete { color: #ff3b30; }

        .loading-state { text-align: center; color: var(--text-muted); margin-top: 2rem; font-style: italic; font-weight: 400; }

        @media (max-width: 600px) {
            body { padding: 1rem 3%; }
            dialog { width: 94%; }
            .recipe-grid { grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
            .card-img { height: 130px; }
            .card-content { padding: 0.8rem; }
            .card-title { font-size: 1.1rem; margin-bottom: 0.2rem; }
            .tag-chip { font-size: 0.65rem; padding: 3px 6px; }
            .search-bar { order: 3; max-width: 100%; width: 100%; margin-top: 0.5rem; }
        }

        @media (min-width: 768px) {
            #viewModal { max-width: 850px; }
            .modal-desktop-split { flex-direction: row; }
            .modal-image-col { flex: 0 0 45%; max-width: 45%; }
            .modal-img { height: 100%; min-height: 350px; border-radius: 20px 0 0 0; }
            .modal-info-col { padding: 2rem 2rem 1rem 2rem; flex: 1; }
            .modal-steps-col { padding: 0 2rem 2rem 2rem; clear: both; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Rez√§pt</h1>
        <input type="text" id="searchInput" class="search-bar" placeholder="Rezepte, Zutaten oder Tags suchen...">
        <button class="btn-add" id="openAddModal" title="Neues Rezept">+</button>
    </header>

    <div id="filterBar" class="tags-container"></div>

    <main class="recipe-grid" id="recipeGrid">
        <div class="loading-state">Lade Rezepte aus der Cloud...</div>
    </main>

    <div id="contextMenu">
        <button class="context-btn" id="btnEdit">
            <span class="context-icon">‚úèÔ∏è</span>
            <span class="context-label">Bearbeiten</span>
        </button>
        <button class="context-btn delete" id="btnDelete">
            <span class="context-icon">üóëÔ∏è</span>
            <span class="context-label">L√∂schen</span>
        </button>
    </div>

    <dialog id="viewModal">
        <button class="btn-close" id="closeViewModal">√ó</button>

        <div class="modal-desktop-split">
            <div class="modal-image-col">
                <img src="" alt="Rezeptbild" class="modal-img" id="viewImg">
            </div>

            <div class="modal-info-col">
                <h2 class="modal-title" id="viewTitle">Titel</h2>
                <div class="tags-container" id="viewTags" style="margin-top: 0;"></div>

                <div class="ingredients-header">
                    <h3>Zutaten</h3>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="btnShareIngredients" class="btn-share" title="Zutaten exportieren/teilen">üõí Export</button>

                        <div class="portions-control" id="portionsControlWrapper">
                            <button id="btnMinusPortion">‚àí</button>
                            <span id="viewPortionsCount">1 Portion</span>
                            <button id="btnPlusPortion">+</button>
                        </div>
                    </div>
                </div>

                <ul id="viewIngredients"></ul>
            </div>
        </div>

        <div class="modal-steps-col">
            <h3 style="margin-bottom: 0.5rem;">Zubereitung</h3>
            <ol id="viewSteps"></ol>
        </div>
    </dialog>

    <dialog id="formModal">
        <button class="btn-close" id="closeFormModal">√ó</button>
        <div class="modal-body" style="padding-top: 3.5rem;">
            <h2 class="modal-title" id="formModalTitle">Neues Rezept</h2>
            <form id="recipeForm">

                <div class="form-row">
                    <div class="form-col-main">
                        <label>Rezeptname</label>
                        <input type="text" id="titleInput" required>
                    </div>
                    <div class="form-col-side">
                        <label>Portionen</label>
                        <input type="number" id="portionsInput" min="1" value="1" required>
                    </div>
                </div>

                <div class="checkbox-row">
                    <input type="checkbox" id="hasPortionsInput" checked>
                    <label for="hasPortionsInput" style="font-weight: normal; cursor: pointer;">Portionen berechnen</label>
                </div>

                <div>
                    <label>Tags</label>
                    <input type="text" id="tagsInput" placeholder="z.B. Fr√ºhst√ºck, Vegan, Schnell">
                    <div class="help-text">Tags mit Kommas trennen.</div>
                </div>

                <div>
                    <label>Rezeptfoto</label>
                    <input type="file" id="imageFile" accept="image/*">
                    <div class="help-text" id="imageHelp">Leer lassen, um das bestehende Bild zu behalten.</div>
                </div>

                <div><label>Zutaten</label><textarea id="ingredientsInput" required></textarea></div>
                <div><label>Zubereitung</label><textarea id="stepsInput" required></textarea></div>

                <button type="submit" class="btn-submit" id="submitBtn">Speichern</button>
            </form>
        </div>
    </dialog>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcQ6lwEMjD_vDkephFPS_hTVknbkC2MZ8",
            authDomain: "gourmet-eb242.firebaseapp.com",
            databaseURL: "https://gourmet-eb242-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gourmet-eb242",
            storageBucket: "gourmet-eb242.firebasestorage.app",
            messagingSenderId: "120771364577",
            appId: "1:120771364577:web:f189f1321828b3522919a0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const recipesCollection = collection(db, "recipes");

        let recipes = [];
        let activeRecipeId = null;
        let activeFilter = null;
        let searchQuery = "";
        let currentEditImageUrl = "";
        let activeViewRecipe = null;
        let currentViewPortions = 1;
        let isTransitioning = false;

        const recipeGrid = document.getElementById('recipeGrid');
        const filterBar = document.getElementById('filterBar');
        const viewModal = document.getElementById('viewModal');
        const formModal = document.getElementById('formModal');
        const contextMenu = document.getElementById('contextMenu');
        const submitBtn = document.getElementById('submitBtn');

        function renderRecipes() {
            if (document.startViewTransition && !isTransitioning) {
                isTransitioning = true;
                const transition = document.startViewTransition(() => {
                    buildGrid();
                });
                transition.finished.finally(() => {
                    isTransitioning = false;
                });
            } else {
                buildGrid();
            }
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            renderRecipes();
        });

        onSnapshot(recipesCollection, (snapshot) => {
            recipes = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            if (recipes.length === 0) {
                recipeGrid.innerHTML = '<div class="loading-state">Noch keine Rezepte vorhanden. Zeit zu kochen!</div>';
                filterBar.innerHTML = '';
            } else {
                renderRecipes();
            }
        });

        function lockScroll() { document.body.classList.add('no-scroll'); }
        function unlockScroll() { document.body.classList.remove('no-scroll'); }
        document.querySelectorAll('dialog').forEach(dialog => dialog.addEventListener('close', unlockScroll));

        function getHue(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            return Math.abs(hash) % 360;
        }

        function getUniqueTags() {
            const allTags = new Set();
            recipes.forEach(r => r.tags && r.tags.forEach(t => allTags.add(t)));
            return Array.from(allTags).sort();
        }

        function renderFilterBar() {
            filterBar.innerHTML = '';
            const uniqueTags = getUniqueTags();
            if (uniqueTags.length === 0) return;

            const allBtn = document.createElement('span');
            allBtn.className = `tag-chip filter-chip filter-all ${activeFilter === null ? 'active' : ''}`;
            allBtn.textContent = 'Alle';
            allBtn.addEventListener('click', () => { activeFilter = null; renderRecipes(); });
            filterBar.appendChild(allBtn);

            uniqueTags.forEach(tag => {
                const btn = document.createElement('span');
                btn.className = `tag-chip filter-chip ${activeFilter === tag ? 'active' : ''}`;
                btn.style.setProperty('--hue', getHue(tag));
                btn.textContent = tag;
                btn.addEventListener('click', () => {
                    activeFilter = (activeFilter === tag) ? null : tag;
                    renderRecipes();
                });
                filterBar.appendChild(btn);
            });
        }

        function generateTagsHTML(tagsArray) {
            if (!tagsArray || tagsArray.length === 0) return '';
            return tagsArray.map(tag => `<span class="tag-chip" style="--hue: ${getHue(tag)};">${tag}</span>`).join('');
        }

        function buildGrid() {
            recipeGrid.innerHTML = '';

            let recipesToShow = activeFilter ? recipes.filter(r => r.tags && r.tags.includes(activeFilter)) : recipes;

            if (searchQuery) {
                recipesToShow = recipesToShow.filter(r => {
                    const titleMatch = r.title.toLowerCase().includes(searchQuery);
                    const tagMatch = r.tags && r.tags.some(t => t.toLowerCase().includes(searchQuery));
                    const ingredientMatch = r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(searchQuery));
                    return titleMatch || tagMatch || ingredientMatch;
                });
            }

            if (recipesToShow.length === 0 && recipes.length > 0) {
                recipeGrid.innerHTML = '<div class="loading-state">Keine Rezepte f√ºr diese Suche gefunden.</div>';
            }

            recipesToShow.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.viewTransitionName = `recipe-card-${recipe.id}`;

                card.innerHTML = `
                    <img src="${recipe.image}" class="card-img" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <div class="card-content">
                        <div class="card-title">${recipe.title}</div>
                        <div class="tags-container">${generateTagsHTML(recipe.tags)}</div>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    if (contextMenu.classList.contains('show')) {
                        contextMenu.classList.remove('show');
                        return;
                    }
                    openViewModal(recipe);
                });

                card.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e.pageX, e.pageY, recipe.id);
                });

                let touchTimer;
                card.addEventListener('touchstart', (e) => {
                    touchTimer = setTimeout(() => {
                        showContextMenu(e.touches[0].pageX, e.touches[0].pageY, recipe.id);
                    }, 500);
                });
                card.addEventListener('touchend', () => clearTimeout(touchTimer));
                card.addEventListener('touchmove', () => clearTimeout(touchTimer));

                recipeGrid.appendChild(card);
            });
            renderFilterBar();
        }

        function parseIngredient(ingredientString) {
            const regex = /^(\d+\s+\d+\/\d+|\d+\/\d+|\d*\.?\d+)\s*(.*)/;
            const match = ingredientString.trim().match(regex);

            if (!match) return { qty: null, text: ingredientString };

            let qtyStr = match[1];
            let text = match[2];
            let qty = 0;

            if (qtyStr.includes('/')) {
                const parts = qtyStr.split(' ');
                if (parts.length === 2) {
                    const whole = parseFloat(parts[0]);
                    const frac = parts[1].split('/');
                    qty = whole + (parseFloat(frac[0]) / parseFloat(frac[1]));
                } else {
                    const frac = parts[0].split('/');
                    qty = parseFloat(frac[0]) / parseFloat(frac[1]);
                }
            } else {
                qty = parseFloat(qtyStr);
            }

            return { qty, text };
        }

        function renderScaledIngredients() {
            const ul = document.getElementById('viewIngredients');
            ul.innerHTML = '';

            const hasPortions = activeViewRecipe.hasPortions !== false;
            const portionsControl = document.getElementById('portionsControlWrapper');

            if (hasPortions) {
                portionsControl.style.display = 'inline-flex';
                const originalPortions = activeViewRecipe.portions || 1;
                const ratio = currentViewPortions / originalPortions;

                activeViewRecipe.ingredients.forEach(ing => {
                    const parsed = parseIngredient(ing);
                    let displayText = ing;

                    if (parsed.qty !== null) {
                        let newQty = parsed.qty * ratio;
                        newQty = Math.round(newQty * 100) / 100;
                        let qtyString = newQty.toString().replace('.', ',');
                        displayText = `${qtyString} ${parsed.text}`;
                    }
                    ul.innerHTML += `<li>${displayText}</li>`;
                });

                const suffix = currentViewPortions === 1 ? 'Portion' : 'Portionen';
                document.getElementById('viewPortionsCount').textContent = `${currentViewPortions} ${suffix}`;
            } else {
                portionsControl.style.display = 'none';
                activeViewRecipe.ingredients.forEach(ing => {
                    ul.innerHTML += `<li>${ing}</li>`;
                });
            }
        }

        function openViewModal(recipe) {
            activeViewRecipe = recipe;
            currentViewPortions = recipe.portions || 1;

            document.getElementById('viewTitle').textContent = recipe.title;
            document.getElementById('viewImg').src = recipe.image;
            document.getElementById('viewTags').innerHTML = generateTagsHTML(recipe.tags);

            renderScaledIngredients();

            document.getElementById('viewSteps').innerHTML = recipe.steps.map(step => `<li>${step}</li>`).join('');

            viewModal.showModal();
            lockScroll();
        }

        document.getElementById('btnMinusPortion').addEventListener('click', () => {
            if (currentViewPortions > 1) {
                currentViewPortions--;
                renderScaledIngredients();
            }
        });

        document.getElementById('btnPlusPortion').addEventListener('click', () => {
            currentViewPortions++;
            renderScaledIngredients();
        });

        document.getElementById('btnShareIngredients').addEventListener('click', async () => {
            if (!activeViewRecipe) return;

            const hasPortions = activeViewRecipe.hasPortions !== false;
            const originalPortions = activeViewRecipe.portions || 1;
            const ratio = hasPortions ? (currentViewPortions / originalPortions) : 1;

            let exportText = `Zutaten f√ºr ${activeViewRecipe.title}:\n\n`;

            activeViewRecipe.ingredients.forEach(ing => {
                const parsed = parseIngredient(ing);
                let displayText = ing;
                if (hasPortions && parsed.qty !== null) {
                    let newQty = parsed.qty * ratio;
                    newQty = Math.round(newQty * 100) / 100;
                    let qtyString = newQty.toString().replace('.', ',');
                    displayText = `${qtyString} ${parsed.text}`;
                }
                exportText += `- ${displayText}\n`;
            });

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Einkaufsliste: ${activeViewRecipe.title}`,
                        text: exportText
                    });
                } catch (err) {
                    console.log("Teilen abgebrochen oder fehlgeschlagen", err);
                }
            } else {
                try {
                    await navigator.clipboard.writeText(exportText);
                    alert("Zutaten in die Zwischenablage kopiert!\n\nDu kannst sie jetzt in Todoist, Bring! oder Notizen einf√ºgen.");
                } catch (err) {
                    alert("Konnte Zutaten nicht kopieren.");
                }
            }
        });

        function showContextMenu(x, y, id) {
            activeRecipeId = id;

            contextMenu.style.transition = 'none';
            contextMenu.classList.add('show');
            const rect = contextMenu.getBoundingClientRect();
            contextMenu.classList.remove('show');

            let posX = x - (rect.width / 2);
            let posY = y - rect.height - 20;

            if (posX < 10) posX = 10;
            if (posX + rect.width > window.innerWidth - 10) posX = window.innerWidth - rect.width - 10;

            if (posY < 10) {
                posY = y + 30;
                contextMenu.style.transformOrigin = 'top center';
            } else {
                contextMenu.style.transformOrigin = 'bottom center';
            }

            contextMenu.style.left = `${posX}px`;
            contextMenu.style.top = `${posY}px`;

            contextMenu.offsetHeight;

            contextMenu.style.transition = '';
            contextMenu.classList.add('show');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.card') && !e.target.closest('#contextMenu')) {
                contextMenu.classList.remove('show');
            }
        });

        document.getElementById('hasPortionsInput').addEventListener('change', (e) => {
            document.getElementById('portionsInput').disabled = !e.target.checked;
        });

        document.getElementById('btnEdit').addEventListener('click', () => {
            contextMenu.classList.remove('show');
            const recipeToEdit = recipes.find(r => r.id === activeRecipeId);

            document.getElementById('formModalTitle').textContent = "Rezept bearbeiten";
            document.getElementById('titleInput').value = recipeToEdit.title;

            const hasPortions = recipeToEdit.hasPortions !== false;
            document.getElementById('hasPortionsInput').checked = hasPortions;
            document.getElementById('portionsInput').value = recipeToEdit.portions || 1;
            document.getElementById('portionsInput').disabled = !hasPortions;

            document.getElementById('tagsInput').value = (recipeToEdit.tags || []).join(', ');
            document.getElementById('ingredientsInput').value = recipeToEdit.ingredients.join('\n');
            document.getElementById('stepsInput').value = recipeToEdit.steps.join('\n');

            document.getElementById('imageFile').value = '';
            currentEditImageUrl = recipeToEdit.image;

            formModal.showModal();
            lockScroll();
        });

        document.getElementById('btnDelete').addEventListener('click', async () => {
            contextMenu.classList.remove('show');
            if (confirm("M√∂chtest du dieses Rezept wirklich l√∂schen?")) {
                await deleteDoc(doc(db, "recipes", activeRecipeId));
            }
        });

        document.getElementById('openAddModal').addEventListener('click', () => {
            activeRecipeId = null;
            currentEditImageUrl = "";
            document.getElementById('formModalTitle').textContent = "Neues Rezept";
            document.getElementById('recipeForm').reset();

            document.getElementById('hasPortionsInput').checked = true;
            document.getElementById('portionsInput').disabled = false;
            document.getElementById('portionsInput').value = 1;

            formModal.showModal();
            lockScroll();
        });

        document.getElementById('recipeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            submitBtn.disabled = true;
            submitBtn.textContent = "Wird hochgeladen... ‚è≥";

            const title = document.getElementById('titleInput').value;
            const hasPortions = document.getElementById('hasPortionsInput').checked;
            const portions = parseInt(document.getElementById('portionsInput').value, 10) || 1;
            const tagsRaw = document.getElementById('tagsInput').value;
            const tags = tagsRaw.split(',').map(t => t.trim()).filter(t => t !== '').map(t => t.charAt(0).toUpperCase() + t.slice(1));
            const ingredients = document.getElementById('ingredientsInput').value.split('\n').map(i => i.trim()).filter(i => i);
            const steps = document.getElementById('stepsInput').value.split('\n').map(s => s.trim()).filter(s => s);

            let finalImageUrl = currentEditImageUrl;

            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            if (file) {
                try {
                    const storageRef = ref(storage, `recipes/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    finalImageUrl = await getDownloadURL(storageRef);
                } catch (error) {
                    console.error("Upload failed:", error);
                    alert("Bild konnte nicht hochgeladen werden. Bitte versuche es erneut.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Speichern";
                    return;
                }
            } else if (!activeRecipeId && !finalImageUrl) {
                finalImageUrl = `https://via.placeholder.com/800x600?text=${encodeURIComponent(title)}`;
            }

            const recipeData = {
                title,
                hasPortions,
                portions,
                tags,
                image: finalImageUrl,
                ingredients,
                steps
            };

            if (activeRecipeId) {
                await updateDoc(doc(db, "recipes", activeRecipeId), recipeData);
            } else {
                await addDoc(recipesCollection, recipeData);
            }

            submitBtn.disabled = false;
            submitBtn.textContent = "Speichern";
            formModal.close();
        });

        document.getElementById('closeFormModal').addEventListener('click', () => formModal.close());
        document.getElementById('closeViewModal').addEventListener('click', () => viewModal.close());
    </script>
</body>
</html>